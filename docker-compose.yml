services:
  # PostgreSQL 数据库
  db:
    build: ./database
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-xmem}
    volumes:
      - db_data:/var/lib/postgresql/data
    # 生产环境不暴露端口，只允许容器内访问
    # ports:
    #   - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 服务器
  redis:
    build: ./redis
    restart: unless-stopped
    # 生产环境不暴露端口，只允许容器内访问
    # ports:
    #   - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 后端 API 服务
  backend:
    build: ./backend
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - OCR_PROVIDER=${OCR_PROVIDER:-local}
      - TESSERACT_CMD=${TESSERACT_CMD:-/usr/bin/tesseract}
      - OCR_API_URL=${OCR_API_URL:-}
      - OCR_API_KEY=${OCR_API_KEY:-}
      - LLM_PROVIDER=${LLM_PROVIDER:-}
      - LLM_API_URL=${LLM_API_URL:-}
      - LLM_API_KEY=${LLM_API_KEY:-}
    # 生产环境建议不暴露端口，只通过 Nginx 代理访问
    # 如需调试，可以取消注释下面的端口映射
    # ports:
    #   - "${BACKEND_PORT:-8000}:8000"
    volumes:
      - ./backend/uploads:/app/uploads
    command: >
      sh -c "
        echo '等待数据库就绪...' &&
        sleep 5 &&
        echo '确保数据库存在...' &&
        python ensure_db.py &&
        echo '创建数据库表结构...' &&
        python init_db.py &&
        echo '标记迁移为已完成...' &&
        alembic stamp head || echo '迁移历史已存在或标记失败' &&
        echo '启动后端服务...' &&
        uvicorn app.main:app --host 0.0.0.0 --port 8000
      "

  # Celery Worker
  celery:
    build: ./backend
    restart: unless-stopped
    depends_on:
      - db
      - redis
      - backend
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - OCR_PROVIDER=${OCR_PROVIDER:-local}
      - TESSERACT_CMD=${TESSERACT_CMD:-/usr/bin/tesseract}
      - OCR_API_URL=${OCR_API_URL:-}
      - OCR_API_KEY=${OCR_API_KEY:-}
      - LLM_PROVIDER=${LLM_PROVIDER:-}
      - LLM_API_URL=${LLM_API_URL:-}
      - LLM_API_KEY=${LLM_API_KEY:-}
    volumes:
      - ./backend/uploads:/app/uploads
    command: celery -A app.celery_app:celery_app worker --loglevel=info --pool=gevent --concurrency=20 --uid=1000

  # Celery Beat (定时任务调度)
  celery-beat:
    build: ./backend
    restart: unless-stopped
    depends_on:
      - db
      - redis
      - backend
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
    command: celery -A app.celery_app:celery_app beat --loglevel=info

  # 前端 Nginx 服务
  frontend:
    build:
      context: ./frontend
      args:
        - VITE_API_URL=${VITE_API_URL:-/api}
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "${FRONTEND_PORT:-80}:80"
      - "${FRONTEND_HTTPS_PORT:-443}:443"
    volumes:
      - ./ssl/certbot/conf:/etc/letsencrypt:ro
      - ./ssl/certbot/www:/var/www/certbot
    environment:
      - CERTBOT_DOMAIN=${CERTBOT_DOMAIN:-xmem.top}

  # Certbot 服务 - 自动续期 SSL 证书
  # 注意：首次证书获取需要使用 HTTPS_MANUAL_SETUP.md 中的步骤
  certbot:
    image: certbot/certbot:latest
    restart: unless-stopped
    volumes:
      - ./ssl/certbot/conf:/etc/letsencrypt
      - ./ssl/certbot/www:/var/www/certbot
    # 每 12 小时检查一次证书续期
    # Let's Encrypt 证书有效期为 90 天，certbot 会在到期前 30 天自动续期
    # 注意：Nginx 会在新的 SSL 握手时自动读取新证书文件，通常不需要重启
    # 如果续期后遇到问题，可以手动执行: docker compose restart frontend
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot --webroot-path=/var/www/certbot --quiet && echo \"证书续期检查完成 ($(date))\" || echo \"证书续期检查失败 ($(date))\" ; sleep 12h & wait $${!}; done;'"
    depends_on:
      - frontend

volumes:
  db_data:
  redis_data:
